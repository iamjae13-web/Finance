name: Macro Risk Monitor (GLD/TLT 실전용)

on:
  schedule:
    - cron: '0 * * * *'  # 매 시간
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas numpy

      - name: Run Macro Risk Check
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          FINRA_CSV_URL: ${{ secrets.FINRA_CSV_URL }}
        run: |
          python - <<'EOF'
          import os
          import requests
          import pandas as pd
          import numpy as np

          BOT_TOKEN = os.environ['TELEGRAM_BOT_TOKEN']
          CHAT_ID = os.environ['TELEGRAM_CHAT_ID']
          FRED_KEY = os.environ['FRED_API_KEY']
          FINRA_URL = os.environ['FINRA_CSV_URL']

          # -------------------------
          # FRED 데이터 가져오기
          def get_fred(series_id):
              url = f'https://api.stlouisfed.org/fred/series/observations?series_id={series_id}&api_key={FRED_KEY}&file_type=json'
              r = requests.get(url)
              data = r.json()['observations']
              df = pd.DataFrame(data)
              df['value'] = pd.to_numeric(df['value'], errors='coerce')
              return df

          # 핵심지표
          vix = get_fred('VIXCLS')['value'].iloc[-1]
          hy_oas = get_fred('BAMLH0A0HYM2')['value'].iloc[-1]
          tips10y = get_fred('DFII10')['value'].iloc[-1]

          # FINRA 마진부채
          margin_df = pd.read_csv(FINRA_URL)
          margin_latest = margin_df['total'].iloc[-1]

          # GLD/TLT 가격
          gld_df = get_fred('GLD')
          tlt_df = get_fred('TLT')

          # -------------------------
          # RSI 계산
          def rsi(prices, period=14):
              delta = prices.diff()
              up, down = delta.copy(), delta.copy()
              up[up < 0] = 0
              down[down > 0] = 0
              roll_up = up.rolling(period).mean()
              roll_down = down.abs().rolling(period).mean()
              rs = roll_up / roll_down
              return 100 - (100 / (1 + rs))

          gld_rsi = rsi(gld_df['value']).iloc[-1]
          tlt_rsi = rsi(tlt_df['value']).iloc[-1]

          # 모멘텀 계산 (5일 % 변화)
          gld_mom = gld_df['value'].pct_change(5).iloc[-1]
          tlt_mom = tlt_df['value'].pct_change(5).iloc[-1]

          # -------------------------
          # 핵심지표 체크 (1개 이상 충족)
          core_flags = [
              vix >= 28,
              hy_oas >= 450,
              tips10y >= 2.0,
              margin_latest >= 1.2e12
          ]
          core_signal = any(core_flags)

          # 보조지표 체크 (1개 이상 충족)
          sub_flags = [
              gld_rsi > 70,
              tlt_rsi > 70,
              gld_mom < -0.01,
              tlt_mom < -0.01
          ]
          sub_signal = any(sub_flags)

          # -------------------------
          # 매도 신호 판단 및 Telegram 전송
          if core_signal and sub_signal:
              msg = f"⚠️ 매도 신호 발생\n핵심지표: {core_flags}\n보조지표: {sub_flags}\nGLD: {gld_df['value'].iloc[-1]:.2f}, TLT: {tlt_df['value'].iloc[-1]:.2f}"
              url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
              requests.get(url, params={"chat_id": CHAT_ID, "text": msg})
          else:
              print("매도 신호 없음")
          EOF
