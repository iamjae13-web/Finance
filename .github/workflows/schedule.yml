name: GLD_TLT_Sell_Scoring_A1

on:
  schedule:
    - cron: '0 * * * *'   # ë§¤ ì •ê° ì‹¤í–‰ (1ì‹œê°„ë§ˆë‹¤)
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas numpy yfinance

      - name: Run GLD/TLT sell scoring (A-1)
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
        run: |
          python - <<'PY'
          import os, sys
          import requests, traceback
          import pandas as pd, numpy as np
          import yfinance as yf
          from datetime import datetime

          # -------------------------
          # í™˜ê²½ë³€ìˆ˜ í™•ì¸
          BOT = os.getenv("TELEGRAM_BOT_TOKEN")
          CHAT = os.getenv("TELEGRAM_CHAT_ID")
          FRED_KEY = os.getenv("FRED_API_KEY")

          def eprint(*a, **k):
              print(*a, **k); sys.stdout.flush()

          if not BOT or not CHAT or not FRED_KEY:
              eprint("ERROR: í•„ìˆ˜ Secrets ëˆ„ë½. TELEGRAM_BOT_TOKEN / TELEGRAM_CHAT_ID / FRED_API_KEY í™•ì¸í•˜ì‹­ì‹œì˜¤.")
              sys.exit(1)

          now = datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")
          eprint("ì‹¤í–‰ì‹œê°:", now)

          # -------------------------
          # FRED helper
          def fred_series(series_id, limit=400):
              try:
                  url = "https://api.stlouisfed.org/fred/series/observations"
                  params = {"series_id": series_id, "api_key": FRED_KEY, "file_type": "json", "limit": limit, "sort_order":"desc"}
                  r = requests.get(url, params=params, timeout=30); r.raise_for_status()
                  obs = r.json().get("observations", [])
                  vals = [(o.get("date"), o.get("value")) for o in obs if o.get("value") not in (".", "", None)]
                  if not vals:
                      return pd.Series(dtype=float)
                  df = pd.DataFrame(vals, columns=["date","value"])
                  df["value"] = pd.to_numeric(df["value"], errors="coerce")
                  df["date"] = pd.to_datetime(df["date"])
                  df = df.sort_values("date").reset_index(drop=True)
                  return df.set_index("date")["value"]
              except Exception as e:
                  eprint("fred_series error", series_id, e)
                  return pd.Series(dtype=float)

          def fred_latest(series_id):
              s = fred_series(series_id, limit=5)
              return float(s.iloc[-1]) if not s.empty else None

          # -------------------------
          # ë°ì´í„° ìˆ˜ì§‘ (7ê°œ ì§€í‘œ)
          # 1) VIX
          vix = fred_latest("VIXCLS")
          # 2) HY OAS (bp)
          hy_oas = fred_latest("BAMLH0A0HYM2")
          # 3) Yield curve 10y-2y
          dgs10 = fred_latest("DGS10")
          dgs2 = fred_latest("DGS2")
          yield_curve = (dgs10 - dgs2) if (dgs10 is not None and dgs2 is not None) else None
          # 4) Unemployment rate series (UNRATE) - monthly
          unrate = fred_series("UNRATE", limit=36)
          # 5) M2 series
          m2 = fred_series("M2SL", limit=400)
          # 6) PMI (ISM manufacturing) - FRED series id candidate 'NAPM' (fallback allowed)
          pmi = fred_series("NAPM", limit=120)
          # 7) SPY momentum (30d) via yfinance
          def yf_close(ticker, period="180d"):
              try:
                  t = yf.Ticker(ticker)
                  df = t.history(period=period, interval="1d")
                  if df is None or df.empty:
                      return pd.Series(dtype=float)
                  return df["Close"].dropna()
              except Exception as e:
                  eprint("yfinance error", ticker, e)
                  return pd.Series(dtype=float)

          spy = yf_close("SPY", period="180d")
          gld = yf_close("GLD", period="180d")
          tlt = yf_close("TLT", period="180d")

          # -------------------------
          # ì§€í‘œë³„ íŒë‹¨ (risk-on / sell-defense ì‹ í˜¸)
          flags = {}

          # VIX: ë‚®ì„ìˆ˜ë¡ ìœ„í—˜ìì‚° ì„ í˜¸ â†’ ë°©ì–´ìì‚° ë§¤ë„ ìœ ë¦¬
          try:
              flags["VIX_low"] = (vix is not None and vix <= 15)
          except:
              flags["VIX_low"] = False

          # HY OAS tight (<=350bp) -> risk-on
          try:
              flags["HY_tight"] = (hy_oas is not None and hy_oas <= 350)
          except:
              flags["HY_tight"] = False

          # Yield curve steepening (10y-2y >= 0.5%p)
          try:
              flags["Yield_steep"] = (yield_curve is not None and yield_curve >= 0.5)
          except:
              flags["Yield_steep"] = False

          # Unemployment MoM drop >=0.10%p improvement => ê²½ê¸° í˜¸ì „ ì‹ í˜¸
          try:
              if not unrate.empty and len(unrate) >= 2:
                  last_un = float(unrate.iloc[-1]); prev_un = float(unrate.iloc[-2])
                  flags["Unrate_improve"] = (last_un <= prev_un - 0.10)
              else:
                  flags["Unrate_improve"] = False
          except:
              flags["Unrate_improve"] = False

          # M2 YoY positive
          try:
              flags["M2_pos"] = False
              if not m2.empty and len(m2) >= 13:
                  m2_yoy = (m2.iloc[-1] / m2.iloc[-13] - 1) * 100
                  flags["M2_pos"] = (m2_yoy > 0)
          except:
              flags["M2_pos"] = False

          # PMI >= 50 indicates expansion
          try:
              flags["PMI_good"] = (not pmi.empty and float(pmi.iloc[-1]) >= 50.0)
          except:
              flags["PMI_good"] = False

          # SPY 30-day momentum > 2%
          try:
              spy_mom30 = None
              if not spy.empty and len(spy) >= 31:
                  spy_mom30 = (spy.iloc[-1] / spy.iloc[-31] - 1) * 100
                  flags["SPY_mom"] = (spy_mom30 >= 2.0)
              else:
                  flags["SPY_mom"] = False
          except:
              flags["SPY_mom"] = False

          # -------------------------
          # ì´ì  ê³„ì‚° (7ê°œ ì§€í‘œ)
          indicator_list = ["VIX_low","HY_tight","Yield_steep","Unrate_improve","M2_pos","PMI_good","SPY_mom"]
          total_points = sum(1 for k in indicator_list if flags.get(k, False))

          # -------------------------
          # ìì‚°ë³„ ì˜í–¥ì§€í‘œ (ê° 4ê°œì”©)
          # GLD ì˜í–¥: VIX_low, HY_tight, PMI_good, SPY_mom
          # TLT ì˜í–¥: Yield_steep, M2_pos, PMI_good, SPY_mom
          gld_indicators = ["VIX_low","HY_tight","PMI_good","SPY_mom"]
          tlt_indicators = ["Yield_steep","M2_pos","PMI_good","SPY_mom"]
          gld_points = sum(1 for k in gld_indicators if flags.get(k, False))
          tlt_points = sum(1 for k in tlt_indicators if flags.get(k, False))

          # -------------------------
          # ë¶„í• ë§¤ë„ ë¹„ìœ¨(A-1 ê¸°ì¤€)
          def split_by_total(tp):
              # tp: total_points (0-7)
              if tp <= 2:
                  return (0, 0)  # no sell
              if 3 <= tp <= 4:
                  return (0.30, 0.70)
              if 5 <= tp <= 6:
                  return (0.50, 0.50)
              if tp >= 7:
                  return (0.70, 0.30)
              return (0,0)

          gld_split = split_by_total(total_points)
          tlt_split = split_by_total(total_points)

          # -------------------------
          # ë§¤ë„ ê¶Œê³  íŒë‹¨: ì´ì  >=3 AND asset_points >=2
          def decide_asset(name, asset_points, split):
              if total_points >= 3 and asset_points >= 2:
                  p1, p2 = split
                  return True, p1, p2
              return False, 0.0, 0.0

          gld_sell, gld_p1, gld_p2 = decide_asset("GLD", gld_points, gld_split)
          tlt_sell, tlt_p1, tlt_p2 = decide_asset("TLT", tlt_points, tlt_split)

          # -------------------------
          # ë©”ì‹œì§€ êµ¬ì„±
          lines = []
          lines.append("ğŸ“Š GLD/TLT ìë™ ê¶Œê³  (ì ìˆ˜í˜• A-1)")
          lines.append(f"ì‹œê°: {now}")
          lines.append(f"ì´ì : {total_points} / 7")
          lines.append("")
          lines.append("ì§€í‘œ ìƒíƒœ(í•µì‹¬):")
          for k in indicator_list:
              v = flags.get(k, False)
              lines.append(f"â€¢ {k}: {'Y' if v else 'N'}")
          lines.append("")
          # GLD ìƒì„¸
          lines.append(f"[GLD] ì˜í–¥ì ìˆ˜: {gld_points}/4")
          if gld_sell:
              lines.append(f"â†’ ê¶Œê³ : ë§¤ë„ (ë¶„í•  2íšŒ) 1ì°¨ {int(gld_p1*100)}% / 2ì°¨ {int(gld_p2*100)}%")
          else:
              lines.append("â†’ ê¶Œê³ : ë³´ë¥˜ (ë§¤ë„ ì•„ë‹˜)")
          # GLD ê·¼ê±° ìƒì„¸
          lines.append("GLD ê·¼ê±°:")
          for k in gld_indicators:
              lines.append(f"â€¢ {k}: {'Y' if flags.get(k, False) else 'N'}")
          lines.append("")

          # TLT ìƒì„¸
          lines.append(f"[TLT] ì˜í–¥ì ìˆ˜: {tlt_points}/4")
          if tlt_sell:
              lines.append(f"â†’ ê¶Œê³ : ë§¤ë„ (ë¶„í•  2íšŒ) 1ì°¨ {int(tlt_p1*100)}% / 2ì°¨ {int(tlt_p2*100)}%")
          else:
              lines.append("â†’ ê¶Œê³ : ë³´ë¥˜ (ë§¤ë„ ì•„ë‹˜)")
          lines.append("TLT ê·¼ê±°:")
          for k in tlt_indicators:
              lines.append(f"â€¢ {k}: {'Y' if flags.get(k, False) else 'N'}")

          # í˜„ì¬ ê°€ê²© ì •ë³´
          lines.append("")
          lines.append(f"GLD ê°€ê²©: {gld.iloc[-1] if not gld.empty else 'NA'}")
          lines.append(f"TLT ê°€ê²©: {tlt.iloc[-1] if not tlt.empty else 'NA'}")
          lines.append("")
          lines.append("ì°¸ê³ : ìë™ë§¤ë§¤ ì•„ë‹˜. ì´ ì•Œë¦¼ì€ ê¶Œê³ ì´ë©° ìµœì¢… ì˜ì‚¬ê²°ì •ì€ ì‚¬ìš©ì í•„ìš”.")

          message = "\n".join(lines)

          # -------------------------
          # í…”ë ˆê·¸ë¨ ì „ì†¡ (ì¡°ê±´: í•œ ìì‚°ì´ë¼ë„ sell ê¶Œê³ ë©´ ì „ì†¡)
          if gld_sell or tlt_sell:
              try:
                  url = f"https://api.telegram.org/bot{BOT}/sendMessage"
                  r = requests.post(url, data={"chat_id": CHAT, "text": message}, timeout=15)
                  eprint("Telegram status:", r.status_code)
              except Exception as e:
                  eprint("Telegram send error:", e)
          else:
              eprint("ì¡°ê±´ ë¯¸ì¶©ì¡±: ì•Œë¦¼ ë¯¸ì „ì†¡. total_points, gld_points, tlt_points =", total_points, gld_points, tlt_points)

          PY
