name: GLD_TLT_Sell_Monitor_NoFINRA

on:
  schedule:
    - cron: '0 * * * *'   # ë§¤ ì •ê° ì‹¤í–‰ (1ì‹œê°„ë§ˆë‹¤)
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas numpy yfinance

      - name: Run GLD/TLT sell-signal check
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
        run: |
          python - <<'PY'
          import os, sys, traceback
          import requests
          import pandas as pd
          import numpy as np
          import yfinance as yf
          from datetime import datetime, timedelta

          # --- í™˜ê²½ë³€ìˆ˜ / ì•ˆì „í™•ì¸ ---
          BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
          CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")
          FRED_KEY = os.getenv("FRED_API_KEY")

          def safe_print(*a, **k): print(*a, **k); sys.stdout.flush()

          if not BOT_TOKEN or not CHAT_ID or not FRED_KEY:
              safe_print("ERROR: í•„ìˆ˜ Secrets ëˆ„ë½. TELEGRAM_BOT_TOKEN / TELEGRAM_CHAT_ID / FRED_API_KEY í™•ì¸í•˜ì‹­ì‹œì˜¤.")
              sys.exit(1)

          now = datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")
          safe_print("ì‹œê°:", now)

          # --- ìœ í‹¸: FREDì—ì„œ ì‹œê³„ì—´ ë˜ëŠ” ìµœì‹ ê°’ ê°€ì ¸ì˜¤ê¸° ---
          def fred_series(series_id, limit=365):
              try:
                  url = "https://api.stlouisfed.org/fred/series/observations"
                  params = {"series_id": series_id, "api_key": FRED_KEY, "file_type": "json", "limit": limit, "sort_order": "desc"}
                  r = requests.get(url, params=params, timeout=30); r.raise_for_status()
                  obs = r.json().get("observations", [])
                  vals = [(o.get("date"), o.get("value")) for o in obs if o.get("value") not in (".", "", None)]
                  if not vals:
                      return pd.Series(dtype=float)
                  df = pd.DataFrame(vals, columns=["date","value"])
                  df["value"] = pd.to_numeric(df["value"], errors="coerce")
                  df["date"] = pd.to_datetime(df["date"])
                  df = df.sort_values("date").reset_index(drop=True)
                  return df.set_index("date")["value"]
              except Exception as e:
                  safe_print("fred_series error", series_id, e)
                  return pd.Series(dtype=float)

          def fred_latest(series_id):
              s = fred_series(series_id, limit=5)
              return float(s.iloc[-1]) if not s.empty else None

          # --- ìœ í‹¸: í…”ë ˆê·¸ë¨ ì „ì†¡ ---
          def send_telegram(text):
              url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
              try:
                  r = requests.post(url, data={"chat_id": CHAT_ID, "text": text}, timeout=15)
                  safe_print("Telegram status", r.status_code)
                  return r.status_code == 200
              except Exception as e:
                  safe_print("Telegram send error:", e)
                  return False

          # --- ì§€í‘œ ìˆ˜ì§‘ ---
          # (í•µì‹¬ í›„ë³´) VIX, HY OAS, 10y, 2y, UNRATE, M2
          vix = fred_latest("VIXCLS")            # VIX
          hy_oas = fred_latest("BAMLH0A0HYM2")  # HY OAS (bp)
          dgs10 = fred_latest("DGS10")
          dgs2 = fred_latest("DGS2")
          unrate_series = fred_series("UNRATE", limit=90)  # monthly
          m2_series = fred_series("M2SL", limit=400)

          # ì‹¤ì‹œê°„ ê°€ê²©ì€ yfinanceë¡œ GLD/TLT/SPY
          def get_price_series(ticker, period="180d"):
              try:
                  t = yf.Ticker(ticker)
                  df = t.history(period=period, interval="1d")
                  if df is None or df.empty:
                      return pd.Series(dtype=float)
                  return df["Close"].dropna()
              except Exception as e:
                  safe_print("yfinance error", ticker, e)
                  return pd.Series(dtype=float)

          gld = get_price_series("GLD", period="180d")
          tlt = get_price_series("TLT", period="180d")
          spy = get_price_series("SPY", period="180d")

          # --- ê¸°ë³¸ ì²´í¬ ---
          safe_print("ë°ì´í„° ìš”ì•½ (ê°€ëŠ¥í•œ ê²ƒë§Œ):")
          safe_print("VIX:", vix, "HY_OAS:", hy_oas, "DGS10:", dgs10, "DGS2:", dgs2)
          safe_print("UNRATE latest:", unrate_series.iloc[-1] if not unrate_series.empty else None)
          safe_print("M2 latest:", m2_series.iloc[-1] if not m2_series.empty else None)
          safe_print("GLD last:", gld.iloc[-1] if not gld.empty else None, "TLT last:", tlt.iloc[-1] if not tlt.empty else None)

          # --- íŒŒìƒ ì§€í‘œ ê³„ì‚° ---
          # ì¥ë‹¨ê¸° ê¸ˆë¦¬ì°¨ (10y - 2y), ë‹¨ìœ„: %p
          yield_curve = None
          if dgs10 is not None and dgs2 is not None:
              yield_curve = dgs10 - dgs2

          # ì‹¤ì—…ë¥  MoM: ìµœì‹ ë‹¬ê³¼ ë°”ë¡œ ì´ì „ë‹¬ ë¹„êµ (ì ˆëŒ€ ì°¨ì´)
          unrate_mom_drop = False
          if not unrate_series.empty and len(unrate_series) >= 2:
              last = float(unrate_series.iloc[-1])
              prev = float(unrate_series.iloc[-2])
              unrate_mom_drop = (last < prev - 0.10)  # 0.10%p ì´ìƒ í•˜ë½ì´ë©´ ê°œì„ ìœ¼ë¡œ ê°„ì£¼

          # M2 ì—°ìœ¨(ìµœê·¼ 12ê°œì›”) ì¦ê°(ë‹¨ìˆœ YoY %)
          m2_yoy_pos = False
          if not m2_series.empty and len(m2_series) >= 13:
              m2_yoy = (m2_series.iloc[-1] / m2_series.iloc[-13] - 1) * 100
              m2_yoy_pos = (m2_yoy > 0)  # M2ê°€ YoY ì¦ê°€ë©´ ì–‘í˜¸ ì‹ í˜¸

          # --- ê¸°ìˆ ì  ì§€í‘œ: RSI(14), ëª¨ë©˜í…€(5ì¼) ---
          def compute_rsi(series, period=14):
              s = series.dropna()
              if s.shape[0] < period+2:
                  return None
              delta = s.diff()
              up = delta.clip(lower=0)
              down = -1 * delta.clip(upper=0)
              ma_up = up.rolling(window=period).mean()
              ma_down = down.rolling(window=period).mean()
              rs = ma_up / ma_down
              rsi = 100 - (100 / (1 + rs))
              return rsi.iloc[-1]

          def mom_pct(series, days=5):
              s = series.dropna()
              if s.shape[0] < days+1:
                  return None
              return (s.iloc[-1] / s.iloc[-(days+1)] - 1)

          gld_rsi = compute_rsi(gld, 14)
          tlt_rsi = compute_rsi(tlt, 14)
          gld_mom5 = mom_pct(gld, 5)
          tlt_mom5 = mom_pct(tlt, 5)

          # SPY 50ì¼ MA ìœ„ ì—¬ë¶€ (ì£¼ì‹ ê°•ì„¸ í‘œì§€)
          spy_above_50 = False
          if not spy.empty and len(spy) >= 60:
              ma50 = spy.rolling(window=50).mean().iloc[-1]
              spy_above_50 = spy.iloc[-1] > ma50

          # --- ì„ê³„ì¹˜ì— ë”°ë¥¸ í•µì‹¬/ë³´ì¡° í”Œë˜ê·¸ ---
          core_flags = []
          try:
              core_flags.append(("VIX low (<=15)", vix is not None and vix <= 15))
              core_flags.append(("HY OAS tight (<=350bp)", hy_oas is not None and hy_oas <= 350))
              core_flags.append(("Yield curve steep (10y-2y >= 0.50%)", yield_curve is not None and yield_curve >= 0.5))
              core_flags.append(("Unrate MoM drop (>=0.10%p)", unrate_mom_drop))
              core_flags.append(("M2 YoY positive", m2_yoy_pos))
          except Exception as e:
              safe_print("core flag calc error", e)

          sub_flags = []
          try:
              sub_flags.append(("GLD RSI>=70", gld_rsi is not None and gld_rsi >= 70))
              sub_flags.append(("TLT RSI>=70", tlt_rsi is not None and tlt_rsi >= 70))
              sub_flags.append(("GLD 5d mom < -1%", gld_mom5 is not None and gld_mom5 <= -0.01))
              sub_flags.append(("TLT 5d mom < -1%", tlt_mom5 is not None and tlt_mom5 <= -0.01))
              sub_flags.append(("SPY above 50d MA", spy_above_50))
          except Exception as e:
              safe_print("sub flag calc error", e)

          # í•µì‹¬ 1ê°œ ì´ìƒ + ë³´ì¡° 1ê°œ ì´ìƒ ì¶©ì¡± ì—¬ë¶€
          core_true = sum(1 for k,v in core_flags if v)
          sub_true = sum(1 for k,v in sub_flags if v)

          safe_print("Core true count:", core_true, "| Sub true count:", sub_true)
          safe_print("Core flags:", core_flags)
          safe_print("Sub flags:", sub_flags)

          # ì•Œë¦¼ ì¡°ê±´
          if core_true >= 1 and sub_true >= 1:
              lines = []
              lines.append("ğŸš¨ GLD/TLT ë§¤ë„ ê¶Œê³  ì•Œë¦¼ (ì°¸ê³ ìš©)")
              lines.append(f"ì‹œê°: {now}")
              lines.append(f"í•µì‹¬ ì¶©ì¡±ê°œìˆ˜: {core_true} / ë³´ì¡° ì¶©ì¡±ê°œìˆ˜: {sub_true}")
              lines.append("")
              lines.append("í•µì‹¬ ì§€í‘œ ìƒì„¸:")
              for k,v in core_flags:
                  lines.append(f"â€¢ {k}: {'Y' if v else 'N'}")
              lines.append("")
              lines.append("ë³´ì¡° ì§€í‘œ ìƒì„¸:")
              for k,v in sub_flags:
                  lines.append(f"â€¢ {k}: {'Y' if v else 'N'}")
              lines.append("")
              lines.append(f"GLD: {gld.iloc[-1] if not gld.empty else 'NA'}  /  TLT: {tlt.iloc[-1] if not tlt.empty else 'NA'}")
              lines.append("ì°¸ê³ : ìë™ë§¤ë§¤ ì•„ë‹˜. ë§¤ë„ ê¶Œê³ ëŠ” ì‚¬ìš©ìê°€ ìµœì¢… íŒë‹¨í•˜ì‹­ì‹œì˜¤.")
              msg = "\n".join(lines)
              send_telegram(msg)
              safe_print("Alert sent.")
          else:
              safe_print("ì¡°ê±´ ë¯¸ì¶©ì¡±: ì•Œë¦¼ ë¯¸ì „ì†¡")
              safe_print("core_true, sub_true:", core_true, sub_true)

          PY
