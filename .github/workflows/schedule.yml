name: Market Risk Monitor

on:
  schedule:
    - cron: "0 21 * * *"  # ë§¤ì¼ ì˜¤ì „ 6ì‹œ (í•œêµ­ì‹œê°„) ì‹¤í–‰
  workflow_dispatch:      # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼

jobs:
  check_indicators:
    runs-on: ubuntu-latest

    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: Python ì„¤ì¹˜
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
        run: |
          pip install requests pandas

      - name: ìœ„í—˜ì§€í‘œ ì ê²€ ì‹¤í–‰
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
        run: |
          python3 << 'EOF'
          import requests, pandas as pd, datetime, os

          # í™˜ê²½ë³€ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸°
          TOKEN = os.environ["TELEGRAM_TOKEN"]
          CHAT_ID = os.environ["TELEGRAM_CHAT_ID"]
          FRED_KEY = os.environ["FRED_API_KEY"]

          def send_telegram(msg):
              url = f"https://api.telegram.org/bot{TOKEN}/sendMessage"
              requests.post(url, data={"chat_id": CHAT_ID, "text": msg})

          # === FRED: 10Y-2Y ìˆ˜ìµë¥  ê³¡ì„  ===
          url_yield = f"https://api.stlouisfed.org/fred/series/observations?series_id=T10Y2Y&api_key={FRED_KEY}&file_type=json"
          data_yield = requests.get(url_yield).json()["observations"]
          last_yield = float(data_yield[-1]["value"])

          # ì„ê³„ì¹˜
          alert = []

          # ìˆ˜ìµë¥  ê³¡ì„  ê²½ê³  ì¡°ê±´
          if last_yield < 0.1:
              alert.append(f"âš  ìˆ˜ìµë¥ ê³¡ì„  ê²½ê³ : {last_yield}%")

          # ì¶”í›„ ë‹¤ë¥¸ ì§€í‘œë“¤ ì¶”ê°€ ì˜ˆì • (OAS, ë§ˆì§„ë¶€ì±„ ë“±)

          if alert:
              msg = "ğŸ“‰ ì‹œì¥ ìœ„í—˜ ì‹ í˜¸ ë°œìƒ!\n" + "\n".join(alert)
              send_telegram(msg)

          EOF
