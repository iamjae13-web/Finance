name: Market Risk Monitor with Charts

on:
  schedule:
    - cron: "0 21 * * *"  # ë§¤ì¼ 21:00 UTC (í•œêµ­ì‹œê°„ ë‹¤ìŒë‚  06:00). í•„ìš”ì‹œ ìˆ˜ì •
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas openpyxl beautifulsoup4 lxml matplotlib

      - name: Run monitor (with charts)
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          FINRA_PAGE_URL: ${{ secrets.FINRA_PAGE_URL }}        # ì„ íƒ, ê¸°ë³¸ FINRA ë§ˆì§„ í˜ì´ì§€ ì‚¬ìš© ê°€ëŠ¥
          BUFFET_CSV_URL: ${{ secrets.BUFFET_CSV_URL }}        # ì„ íƒ
          HY_OAS_THRESHOLD: ${{ secrets.HY_OAS_THRESHOLD }}    # ì„ íƒ (ê¸°ë³¸ 400)
          MARGIN_THRESHOLD: ${{ secrets.MARGIN_THRESHOLD }}    # ì„ íƒ (ê¸°ë³¸ 1e12)
          BUFFET_THRESHOLD: ${{ secrets.BUFFET_THRESHOLD }}    # ì„ íƒ (ê¸°ë³¸ 200)
        run: |
          python3 - <<'PYCODE'
          import os, requests, io, re
          import pandas as pd
          import matplotlib
          matplotlib.use('Agg')
          import matplotlib.pyplot as plt
          from datetime import datetime
          from bs4 import BeautifulSoup

          # í™˜ê²½ë³€ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸°
          TOKEN = os.getenv("TELEGRAM_TOKEN")
          CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")
          FRED_KEY = os.getenv("FRED_API_KEY")
          FINRA_PAGE_URL = os.getenv("FINRA_PAGE_URL") or "https://www.finra.org/rules-guidance/key-topics/margin-accounts/margin-statistics"
          BUFFET_CSV_URL = os.getenv("BUFFET_CSV_URL")

          try:
              HY_OAS_THRESHOLD = float(os.getenv("HY_OAS_THRESHOLD", "400"))
          except:
              HY_OAS_THRESHOLD = 400.0
          try:
              MARGIN_THRESHOLD = float(os.getenv("MARGIN_THRESHOLD", str(1.0e12)))
          except:
              MARGIN_THRESHOLD = 1.0e12
          try:
              BUFFET_THRESHOLD = float(os.getenv("BUFFET_THRESHOLD", "200"))
          except:
              BUFFET_THRESHOLD = 200.0

          now = datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")

          # ---------- ìœ í‹¸: í…”ë ˆê·¸ë¨ ì „ì†¡ ----------
          def telegram_send_text(text):
              if not TOKEN or not CHAT_ID:
                  print("í…”ë ˆê·¸ë¨ ì„¤ì • ì—†ìŒ.")
                  return False
              url = f"https://api.telegram.org/bot{TOKEN}/sendMessage"
              try:
                  r = requests.post(url, data={"chat_id": CHAT_ID, "text": text}, timeout=15)
                  print("telegram text status", r.status_code)
                  return r.status_code == 200
              except Exception as e:
                  print("telegram_send_text error:", e)
                  return False

          def telegram_send_photo(photo_path, caption=None):
              if not TOKEN or not CHAT_ID:
                  print("í…”ë ˆê·¸ë¨ ì„¤ì • ì—†ìŒ.")
                  return False
              url = f"https://api.telegram.org/bot{TOKEN}/sendPhoto"
              try:
                  with open(photo_path, "rb") as f:
                      files = {"photo": f}
                      data = {"chat_id": CHAT_ID}
                      if caption:
                          data["caption"] = caption
                      r = requests.post(url, data=data, files=files, timeout=30)
                      print("telegram photo status", r.status_code, r.text[:200])
                      return r.status_code == 200
              except Exception as e:
                  print("telegram_send_photo error:", e)
                  return False

          # ---------- FRED helper (ë‹¨ì¼ ìµœì‹  ê´€ì¸¡ ë° ì‹œê³„ì—´) ----------
          def fred_latest(series_id):
              base = "https://api.stlouisfed.org/fred/series/observations"
              params = {"series_id": series_id, "api_key": FRED_KEY, "file_type": "json", "limit": 1, "sort_order": "desc"}
              try:
                  r = requests.get(base, params=params, timeout=20); r.raise_for_status()
                  j = r.json().get("observations", [])
                  if not j: return None
                  v = j[0].get("value")
                  if v in (".", "", None): return None
                  return float(v)
              except Exception as e:
                  print("fred_latest error", series_id, e)
                  return None

          def fred_series(series_id, limit=120):
              base = "https://api.stlouisfed.org/fred/series/observations"
              params = {"series_id": series_id, "api_key": FRED_KEY, "file_type": "json", "limit": limit, "sort_order": "desc"}
              try:
                  r = requests.get(base, params=params, timeout=30); r.raise_for_status()
                  obs = r.json().get("observations", [])
                  vals = [(o.get("date"), o.get("value")) for o in obs if o.get("value") not in (".", "", None)]
                  if not vals: return []
                  # chronological order
                  vals = vals[::-1]
                  dates = [d for d,v in vals]
                  values = [float(v) for d,v in vals]
                  return dates, values
              except Exception as e:
                  print("fred_series error", series_id, e)
                  return [], []

          # ---------- FINRA ë§ˆì§„ë¶€ì±„ ì¶”ì¶œ (í˜ì´ì§€ì—ì„œ ì—‘ì…€ ë§í¬ ì°¾ì•„ íŒŒì‹±) ----------
          def fetch_finra_margin_from_page(page_url):
              try:
                  r = requests.get(page_url, timeout=20); r.raise_for_status()
              except Exception as e:
                  print("FINRA page fetch error:", e)
                  return None
              soup = BeautifulSoup(r.text, "lxml")
              links = []
              for a in soup.find_all("a", href=True):
                  href = a["href"]
                  if re.search(r'\.xls[x]?$', href, re.IGNORECASE):
                      links.append(href if href.startswith("http") else requests.compat.urljoin(page_url, href))
              if not links:
                  print("FINRA: ì—‘ì…€ ë§í¬ ë¯¸ë°œê²¬.")
                  return None
              for link in links:
                  try:
                      rr = requests.get(link, timeout=30); rr.raise_for_status()
                      xls = pd.read_excel(io.BytesIO(rr.content), sheet_name=0, header=None)
                      df = xls.fillna("")
                      found = []
                      for r_i in range(max(0, df.shape[0]-20), df.shape[0]):
                          row = df.iloc[r_i]
                          for cell in row:
                              s = str(cell)
                              if re.search(r'[\d\$,]{3,}', s):
                                  s2 = re.sub(r'[^0-9.\-]', '', s)
                                  try:
                                      val = float(s2)
                                      found.append(val)
                                  except:
                                      continue
                      if found:
                          cand = sorted(found)[-1]
                          return float(cand)
                  except Exception as e:
                      print("FINRA link read error:", e, "link:", link)
                      continue
              return None

          # ---------- ë²„í•ì§€ìˆ˜(ì„ íƒ) ----------
          def fetch_buffett_from_csv(csv_url):
              try:
                  r = requests.get(csv_url, timeout=20); r.raise_for_status()
                  df = pd.read_csv(io.StringIO(r.text))
                  numeric_cols = [c for c in df.columns if pd.api.types.is_numeric_dtype(df[c])]
                  if numeric_cols:
                      col = numeric_cols[-1]
                      val = df[col].dropna().iloc[-1]
                      return float(val)
                  # fallback: try last row string parse
                  for c in df.columns[::-1]:
                      vals = df[c].dropna().astype(str)
                      if not vals.empty:
                          s = vals.iloc[-1]
                          m = re.search(r'([0-9]+\.[0-9]+|[0-9]+)', s.replace(',', ''))
                          if m:
                              return float(m.group(1))
                  return None
              except Exception as e:
                  print("fetch_buffett error", e)
                  return None

          # ---------- ìˆ˜ì§‘: ì£¼ìš” ì§€í‘œ ----------
          FED = fred_latest("FEDFUNDS")
          dgs10 = fred_latest("DGS10")
          dgs2 = fred_latest("DGS2")
          hy_oas = fred_latest("BAMLH0A0HYM2")
          yield_curve = None
          if dgs10 is not None and dgs2 is not None:
              yield_curve = dgs10 - dgs2

          margin = fetch_finra_margin_from_page(FINRA_PAGE_URL)
          buffett = fetch_buffett_from_csv(BUFFET_CSV_URL) if BUFFET_CSV_URL else None

          # ì‹œê³„ì—´(ê·¸ë˜í”„) ê°€ëŠ¥í•œ ë°ì´í„° ìˆ˜ì§‘
          dates_yc10, vals_dgs10 = fred_series("DGS10", limit=180)
          dates_yc2, vals_dgs2 = fred_series("DGS2", limit=180)
          _, vals_hy = fred_series("BAMLH0A0HYM2", limit=180)

          # ---------- í•©ì„± ì‹ í˜¸ ê³„ì‚° (ì •ê·œí™” ë° ê°€ì¤‘í•©) ----------
          def clamp(x, lo=0.0, hi=1.0):
              try:
                  return max(lo, min(hi, float(x)))
              except:
                  return lo

          # VIXì™€ SP500 ë“œë¡œìš°ë‹¤ìš´ ì‹œë„(ì„ íƒ; ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ)
          def fetch_vix():
              return fred_latest("VIXCLS")
          def fetch_sp_drawdown():
              # SP500 ì—­ì‚¬ì¹˜ (SP500 ì‹œë¦¬ì¦ˆ idëŠ” 'SP500'ì´ ì•„ë‹Œ ê²½ìš°ê°€ ìˆìŒ; FREDì— 'SP500' ì‹œë¦¬ì¦ˆ ì¡´ì¬ ì—¬ë¶€ í™•ì¸)
              try:
                  dates_sp, vals_sp = fred_series("SP500", limit=60)
                  if not vals_sp:
                      return None
                  recent_max = max(vals_sp)
                  recent_min = min(vals_sp)
                  return (recent_max - recent_min) / recent_max * 100.0
              except:
                  return None

          vix = fetch_vix()
          sp_draw = fetch_sp_drawdown()

          # ì ìˆ˜ ì‚°ì¶œ
          yc_score = clamp((0 - (yield_curve if yield_curve is not None else 0.0)) / 2.0)
          hy_score = clamp(((hy_oas if hy_oas is not None else 0.0) - 200.0) / 400.0)
          margin_score = clamp(((margin if margin is not None else 0.0) / 1.0e12 - 0.5) / 1.5)
          vix_score = clamp(((vix if vix is not None else 15.0) - 15.0) / 25.0)
          sp_score = clamp(((sp_draw if sp_draw is not None else 0.0) / 20.0))
          buffett_score = clamp(((buffett if buffett is not None else 0.0) - 150.0) / 150.0)

          weights = {"yc":0.20, "hy":0.25, "margin":0.20, "vix":0.15, "sp":0.15, "buffett":0.05}
          total_w = weights["yc"] + weights["hy"] + weights["margin"] + weights["vix"] + weights["sp"] + (weights["buffett"] if buffett is not None else 0)
          R = (yc_score*weights["yc"] + hy_score*weights["hy"] + margin_score*weights["margin"] + vix_score*weights["vix"] + sp_score*weights["sp"] + (buffett_score*weights["buffett"] if buffett is not None else 0.0)) / total_w

          # ê¶Œê³  ë§¤ë„ ë¹„ìœ¨(ì˜ˆì‹œ)
          if R < 0.35:
              sell_reco = "ìœ ì§€"
              sell_pct = 0
          elif R < 0.6:
              sell_reco = "ì£¼ì˜ - ë°©ì–´ìì‚° ì¼ë¶€ ë§¤ë„ ê³ ë ¤"
              sell_pct = 0.10
          elif R < 0.8:
              sell_reco = "ê²½ê³  - ë°©ì–´ìì‚° ì¶”ê°€ ë§¤ë„ ê¶Œê³ "
              sell_pct = 0.35
          else:
              sell_reco = "ìœ„ê¸° - ì¦‰ì‹œ ìœ ë™ì„± í™•ë³´ ê¶Œê³ "
              sell_pct = 0.75

          # ---------- ì‹œê°í™”: ì°¨íŠ¸ ìƒì„± ----------
          try:
              fig = plt.figure(figsize=(10, 10))
              # 1) ìƒë‹¨: 10y & 2y ì‹œê³„ì—´(ìˆì„ ë•Œ)
              ax1 = fig.add_subplot(3,1,1)
              if vals_dgs10 and vals_dgs2:
                  ax1.plot(dates_yc10, vals_dgs10, label='10y')
                  ax1.plot(dates_yc2, vals_dgs2, label='2y')
                  ax1.set_title('10y vs 2y (ìµœê·¼)')
                  ax1.tick_params(axis='x', rotation=20)
                  ax1.legend()
              else:
                  ax1.text(0.1,0.5,'10y/2y ë°ì´í„° ì—†ìŒ', transform=ax1.transAxes)

              # 2) ì¤‘ê°„: HY OAS ì‹œê³„ì—´
              ax2 = fig.add_subplot(3,1,2)
              if vals_hy:
                  ax2.plot(range(len(vals_hy)), vals_hy)
                  ax2.set_title('HY OAS (ìµœê·¼)')
                  ax2.tick_params(axis='x', rotation=20)
              else:
                  ax2.text(0.1,0.5,'HY OAS ë°ì´í„° ì—†ìŒ', transform=ax2.transAxes)

              # 3) í•˜ë‹¨: ì§€í‘œ ì ìˆ˜ ë°”ì°¨íŠ¸
              ax3 = fig.add_subplot(3,1,3)
              labels = ['10y-2y','HY OAS','Margin','VIX','SP DD'] + (['Buffett'] if buffett is not None else [])
              scores = [yc_score, hy_score, margin_score, vix_score, sp_score] + ([buffett_score] if buffett is not None else [])
              ax3.bar(range(len(scores)), scores)
              ax3.set_ylim(0,1)
              ax3.set_xticks(range(len(scores)))
              ax3.set_xticklabels(labels, rotation=30)
              ax3.set_title('ì§€í‘œë³„ ë¦¬ìŠ¤í¬ ì ìˆ˜ (0-1)')

              plt.tight_layout()
              img_path = "/tmp/market_monitor_chart.png"
              fig.savefig(img_path, dpi=150)
              plt.close(fig)
              chart_ok = True
          except Exception as e:
              print("chart generation error:", e)
              chart_ok = False
              img_path = None

          # ---------- ì´ìƒì§•í›„ê°€ ìˆì„ ë•Œë§Œ ì•Œë¦¼ ì „ì†¡ ----------
          alerts = []
          if yield_curve is not None and yield_curve < 0:
              alerts.append(f"ì¥ë‹¨ê¸° ê¸ˆë¦¬ ì—­ì „ (10y-2y): {yield_curve:.2f}%")
          if hy_oas is not None and hy_oas > HY_OAS_THRESHOLD:
              alerts.append(f"í•˜ì´ì¼ë“œ OAS ê³¼ì—´: {hy_oas} bp (ì„ê³„ì¹˜ {HY_OAS_THRESHOLD})")
          if margin is not None and margin > MARGIN_THRESHOLD:
              alerts.append(f"ë§ˆì§„ë¶€ì±„ ê¸‰ì¦: ${margin:,.0f} (ì„ê³„ì¹˜ ${MARGIN_THRESHOLD:,.0f})")
          if buffett is not None and buffett > BUFFET_THRESHOLD:
              alerts.append(f"ë²„í•ì§€ìˆ˜ ê³¼ëŒ€í‰ê°€: {buffett} (ì„ê³„ì¹˜ {BUFFET_THRESHOLD})")

          # Composite ê¸°ë°˜ ì¶”ê°€ ì¡°ê±´ (ì˜µì…˜)
          if R >= 0.35 and ("í•©ì„± R ê²½ê³„" not in alerts):
              # ì—¬ê¸°ëŠ” ë³„ë„ ì•Œë¦¼ì¡°ê±´ìœ¼ë¡œ ì‚¬ìš©ìê°€ ì›í•˜ë©´ í™œì„±í™”(í˜„ì¬ëŠ” composite ê¸°ë°˜ ê¶Œê³  í¬í•¨)
              alerts.append(f"í•©ì„±ìœ„í—˜ R = {R:.2f} (ê¶Œê³ : {sell_reco}, ê¶Œì¥ ë§¤ë„ë¹„ìœ¨ ì˜ˆì‹œ: {int(sell_pct*100)}%)")

          if alerts:
              text = "ğŸš¨ ìë™ê°ì‹œ ê²½ë³´\n" + f"ì‹œê°: {now}\n\n" + "\n".join(["â€¢ " + a for a in alerts]) + "\n\n" + f"ìš”ì•½: FED={FED} 10y={dgs10} 2y={dgs2} 10y-2y={yield_curve} HY_OAS={hy_oas} Margin={margin} Buffett={buffett}\n"
              # í…ìŠ¤íŠ¸ ì „ì†¡ ë¨¼ì €
              tx_ok = telegram_send_text(text)
              # ì°¨íŠ¸ ì „ì†¡(ê°€ëŠ¥í•˜ë©´)
              if chart_ok and img_path:
                  cap = f"Composite R={R:.2f} | ê¶Œê³ : {sell_reco} | ë§¤ë„ ì˜ˆì‹œ {int(sell_pct*100)}%"
                  photo_ok = telegram_send_photo(img_path, caption=cap)
                  if not photo_ok:
                      print("ì°¨íŠ¸ ì „ì†¡ ì‹¤íŒ¨.")
              print("Alert sent.")
          else:
              print(now, "- ì´ìƒì§•í›„ ì—†ìŒ. ì•Œë¦¼ ë¯¸ì „ì†¡.")
          PYCODE
